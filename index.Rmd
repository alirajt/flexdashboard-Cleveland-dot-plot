---
title: "Raccomandate"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flexdashboard)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(DT)
library(ggpubr)

Raccomandate <- read_excel("mock-data.xlsx")
Raccomandate$Arrivo <- ymd(Raccomandate$Arrivo)
Raccomandate$Scadenza <- ymd(Raccomandate$Scadenza)

# deadline for sequenzes
SC_A <- ymd("2019-05-31")
SC_B <- ymd("2019-05-29")
SC_C <- ymd("2019-05-30")

Raccomandate$Scadono <- ifelse(Raccomandate$Seq == "A", Raccomandate$Scadenza <= SC_A,
                               ifelse(Raccomandate$Seq == "B", Raccomandate$Scadenza <= SC_B, 
                                      Raccomandate$Scadenza <= SC_C))
Raccomandate <- Raccomandate %>%
  mutate(Scadono = ifelse(Scadono == TRUE, "SI", "NO"))

Scad <- Raccomandate %>%
  filter(Scadono == "SI")

Certificate <- read_excel("Certificate.xlsx")
```


Plot {data-icon="fa-signal"}
===========================================================

Row {data-height=100}
----------------------------------------------
### Delivery-Racc

```{r echo=FALSE}
numeroRacc <- Raccomandate %>% count()
valueBox(numeroRacc, icon = "fa-archive")
```

### Expiring Delivery-Racc

```{r echo=FALSE}
raccScad <- Raccomandate %>%
  filter(Scadono == "SI") %>%
  count()
valueBox(raccScad, icon = "fa-hourglass-half", color = "warning")
```

### Delivery-Cert

```{r echo=FALSE}
numeroCert <- Certificate %>% count()
valueBox(numeroCert, icon = "fa-envelope")
```

### Expiring Delivery-Cert

```{r echo=FALSE}
certNO <- Certificate %>%
  filter(Esito == "NO") %>%
  count()
valueBox(certNO, icon = "fa-exclamation", color = "warning")
```

### Last Update

```{r echo=FALSE}
valueBox(substr(now(), 6, 16))
```

Row
----------------------------------------------

### Delivery-Racc Plot

```{r echo=FALSE}
grpost <- Raccomandate %>%
  group_by(Postino, Seq, Scadono) %>%
  count()

ggdotchart(grpost, x = "Postino", y = "n",
           color = "Scadono",
           add = "segments",
           rotate = TRUE,
           group = "Postino",
           facet.by = "Seq",
           xlab = FALSE,
           ylab = FALSE,
           dot.size = 8,
           label = round(grpost$n),
           font.label = list(color = "white", size = 9, 
                             vjust = 0.5))

```


### Delivery-Cert Plot
```{r echo=FALSE}

grCert <- Certificate %>%
  group_by(Postino, Esito) %>%
  count()

ggdotchart(grCert, x = "Postino", y = "n",
           color = "Esito",
           #palette = c("#00AFBB", "#E7B800", "#FC4E07"),
           sorting = "descending",
           add = "segments",
           rotate = TRUE,
           group = "Esito",
           xlab = FALSE,
           ylab = FALSE,
           facet.by = "Esito",
           dot.size = 10,
           label = round(grCert$n),
           font.label = list(color = "black", size = 8, 
                             vjust = 0.5),
           ggtheme = theme_pubr())
